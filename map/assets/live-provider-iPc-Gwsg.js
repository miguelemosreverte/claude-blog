import{_ as N}from"./index-Cpi14mRT.js";const S=62,A=43,m=10,v=52,q=.5,V=Math.ceil((S-A)/q),tt=Math.ceil((v-m)/q),F=.2,X=Math.ceil((S-A)/F),nt=Math.ceil((v-m)/F),z=6,D=256,B=18;function Z(e){const r=1<<z,t=e*Math.PI/180;return(1-Math.log(Math.tan(t)+1/Math.cos(t))/Math.PI)/2*r*D-B*D}function et(e){const r=1<<z,t=e+B*D,s=Math.PI*(1-2*t/(r*D));return Math.atan(Math.sinh(s))*180/Math.PI}const R=Z(S),ot=Z(A);function $(e){const r=new Float64Array(e);for(let t=0;t<e;t++){const s=R+(t+.5)*(ot-R)/e;r[t]=et(s)}return r}const rt=$(V),st=$(X);let I=[],O=[],C=[],U=[],h=[],j={},G=!1;const L=new Map;function it(e,r,t,s,o){let n=0;for(const a of t){const i=s[a.id];if(!i||i==="neutral")continue;const l=e-a.lat,c=r-a.lon,f=l*l+c*c;if(f>64)continue;const u=i==="axis"?1:-1,d=o[a.id]||{};let _=d.strength!=null?d.strength:a.major?1.5:1;for(const[k,p]of Object.entries(d))k==="strength"||typeof p!="number"||p>=0&&p<=1&&(_*=1-p);const g=1+f,y=j[a.id]||3;y===3?n+=u*_/(g*g*g):n+=u*_/Math.pow(g,y)}return n}function H(e,r,t){const s={},o={};for(const n of r)s[n.id]=n.startControl,o[n.id]={};for(const n of t){if(n.date>e)break;s[n.cityId]=n.control,n.labels&&Object.assign(o[n.cityId],n.labels)}return{ctrl:s,labels:o}}function ct(e,r,t,s,o,n){const a=[null,[[3,2]],[[2,1]],[[3,1]],[[0,1]],[[3,0],[2,1]],[[0,2]],[[3,0]],[[3,0]],[[0,2]],[[0,1],[3,2]],[[0,1]],[[3,1]],[[2,1]],[[3,2]],null],i=[];for(let l=0;l<r-1;l++)for(let c=0;c<t-1;c++){let b=function(E,x,Q){return E+(x-E)*Q};const f=e[l*t+c],u=e[l*t+c+1],d=e[(l+1)*t+c],_=e[(l+1)*t+c+1],g=(f>0?8:0)|(u>0?4:0)|(_>0?2:0)|(d>0?1:0),y=a[g];if(!y)continue;const k=s[l],p=s[l+1],w=o+c*n,P=o+(c+1)*n,T=[[k,b(w,P,f/(f-u||1))],[b(k,p,u/(u-_||1)),P],[p,b(w,P,d/(d-_||1))],[b(k,p,f/(f-d||1)),w]];for(const[E,x]of y)i.push(T[E][0],T[E][1],T[x][0],T[x][1])}return new Float32Array(i)}function K(e){return Math.floor(new Date(e).getTime()/864e5)}function M(e,r,t){return e+(r-e)*t}function W(e){if(e.length===0)return[0,0];let r=0,t=0;for(const s of e)r+=s[0],t+=s[1];return[r/e.length,t/e.length]}function Y(e,r,t){if(e.length===0&&r.length===0)return[];if(e.length===0){const n=W(r);e=r.map(()=>n)}if(r.length===0){const n=W(e);r=e.map(()=>n)}const s=Math.max(e.length,r.length),o=[];for(let n=0;n<s;n++){const a=e[Math.min(n,e.length-1)],i=r[Math.min(n,r.length-1)];o.push([M(a[0],i[0],t),M(a[1],i[1],t)])}return o}function lt(e,r){const t=e.keyframes;if(!t||t.length===0||r<e.start||r>e.end)return null;const s=K(r);let o=null,n=null;for(let c=0;c<t.length;c++){const f=K(t[c].date);f<=s&&(o={idx:c,days:f,kf:t[c]}),f>=s&&!n&&(n={idx:c,days:f,kf:t[c]})}if(!o&&!n)return null;if(!o)return{...n.kf};if(!n)return{...o.kf};if(o.idx===n.idx)return{...o.kf};const a=n.days-o.days,i=a>0?(s-o.days)/a:0,l={date:r};return o.kf.perimeter!==void 0&&(l.perimeter=Y(o.kf.perimeter,n.kf.perimeter,i)),o.kf.path!==void 0&&(l.path=Y(o.kf.path,n.kf.path,i),l.width=M(o.kf.width||0,n.kf.width||0,i)),o.kf.center!==void 0&&(l.center=[M(o.kf.center[0],n.kf.center[0],i),M(o.kf.center[1],n.kf.center[1],i)],l.radius=M(o.kf.radius||0,n.kf.radius||0,i)),l}function at(e,r,t){if(!t||t.length<3)return!1;let s=!1;const o=t.length;for(let n=0,a=o-1;n<o;a=n++){const i=t[n][0],l=t[n][1],c=t[a][0],f=t[a][1];i>e!=c>e&&r<(f-l)*(e-i)/(c-i)+l&&(s=!s)}return s}function ft(e,r,t,s){const o=s[1]-t[1],n=s[0]-t[0],a=o*o+n*n;if(a===0){const d=r-t[1],_=e-t[0];return Math.sqrt(d*d+_*_)}let i=((r-t[1])*o+(e-t[0])*n)/a;i=Math.max(0,Math.min(1,i));const l=t[1]+i*o,c=t[0]+i*n,f=r-l,u=e-c;return Math.sqrt(f*f+u*u)}function ut(e,r,t,s){if(!t||t.length<2||s<=0)return!1;const o=s/2;for(let n=0;n<t.length-1;n++)if(ft(e,r,t[n],t[n+1])<o)return!0;return!1}function dt(e,r,t,s){if(!t||s<=0)return!1;const o=e-t[0],n=r-t[1];return Math.sqrt(o*o+n*n)<s}function _t(e){return e.type==="pocket"?e.trapped==="axis"?1:-1:e.side==="axis"?1:-1}function ht(e,r,t,s){const o=t.type;return o==="pocket"||o==="salient"?at(e,r,s.perimeter):o==="corridor"?ut(e,r,s.path,s.width):o==="bridgehead"?dt(e,r,s.center,s.radius):!1}function gt(e,r,t,s,o,n,a,i){if(!a||a.length===0)return;const l=[];for(const c of a){if(i<c.start||i>c.end)continue;const f=lt(c,i);if(!f||f.perimeter&&f.perimeter.length<3||f.path&&(f.path.length<2||(f.width||0)<=0)||f.center&&(f.radius||0)<=0)continue;const u=_t(c),d=c.strength||1.5;l.push({geo:c,shape:f,override:u*d})}if(l.length!==0)for(let c=0;c<r;c++){const f=s[c];for(let u=0;u<t;u++){const d=o+(u+.5)*n;for(const{geo:_,shape:g,override:y}of l)if(ht(f,d,_,g)){e[c*t+u]=y;break}}}}function pt(e,r,t,s,o,n,a){const i=new Float32Array(e*r);for(let l=0;l<e;l++){const c=t[l];for(let f=0;f<r;f++){const u=s+(f+.5)*o;i[l*r+f]=it(c,u,I,n,a)}}return i}function J(e,r){const t=`${e}:${r}`;if(L.has(t))return L.get(t);const s=h[e];if(!s)return null;const{ctrl:o,labels:n}=H(s.date_iso,I,O),a=r===0?V:X,i=r===0?tt:nt,l=r===0?q:F,c=r===0?rt:st,f=pt(a,i,c,m,l,o,n);gt(f,a,i,c,m,l,U,s.date_iso);const u=ct(f,a,i,c,m+.5*l,l),d={rows:a,cols:i,lat_min:A,lat_max:S,lon_min:m,lon_max:v,field_data:f},_={zone_id:"global",segments:u,seg_count:u.length/4},g={tile:d,contour:_};return L.set(t,g),g}async function mt(){if(G)return;const e=(await N(async()=>{const{default:n}=await import("./eastern-front-EtqqQfSf.js");return{default:n}},[])).default;try{j=(await N(async()=>{const{default:n}=await import("./kernel-n-map-Djdz4xlO.js");return{default:n}},[])).default}catch{j={}}I=e.cities.map(([n,a,i,l,c,f])=>({id:n,name:a,lat:i,lon:l,major:c,startControl:f})),O=e.events.map(([n,a,i,l])=>({date:n,cityId:a,control:i,labels:l||{}})),C=e.labels.map(([n,a,i])=>({date:n,label:a,sub:i})),U=e.geometry||[];const r=new Map(C.map(n=>[n.date,n])),t=[...new Set([...O.map(n=>n.date),...C.map(n=>n.date)])].sort(),s=t[0],o=(()=>{const n=new Date(s);return n.setDate(n.getDate()-1),n.toISOString().slice(0,10)})();t.includes(o)||t.unshift(o),h=t.map((n,a)=>{const i=r.get(n),l=n===o;return{date_idx:a,date_iso:n,is_keyframe:i||l?1:0,label:i?i.label:l?"Pre-War":null,sublabel:i?i.sub:l?"Eve of Operation Barbarossa":null}}),L.clear(),G=!0}function Mt(){return h}function kt(e){const r=h.findIndex(o=>o.date_iso===e);if(r>=0)return r;let t=h.length;for(let o=0;o<h.length;o++)if(h[o].date_iso>e){t=o;break}const s={date_idx:t,date_iso:e,is_keyframe:0,label:null,sublabel:null};h.splice(t,0,s);for(let o=t;o<h.length;o++)h[o].date_idx=o;return L.clear(),t}function Et(){return h.filter(e=>e.is_keyframe===1)}function Lt(){return I.map(e=>({city_id:e.id,name:e.name,lat:e.lat,lon:e.lon,is_major:e.major?1:0,start_control:e.startControl}))}function It(e,r){const t=J(e,r);return t?t.tile:null}function bt(e,r){const t=J(e,r);return t?[t.contour]:[]}function Tt(e,r){const t=h[e];if(!t)return{};const{ctrl:s,labels:o}=H(t.date_iso,I,O),n={};for(const a of r){const i=a.city_id,l=s[i]||a.start_control,c=o[i]||{};let f=c.strength!=null?c.strength:a.is_major?1.5:1;for(const[u,d]of Object.entries(c))u==="strength"||typeof d!="number"||d>=0&&d<=1&&(f*=1-d);n[i]={control:l,strength:f}}return n}export{kt as ensureDate,mt as initLive,Lt as queryAllCities,bt as queryAllContours,Tt as queryCityStates,Mt as queryDates,It as queryGlobalTile,Et as queryKeyframes};
